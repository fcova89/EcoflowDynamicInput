alias: Regola Potenza AC EcoFlow Delta 2
description: Regola la potenza di carica AC in base all'energia esportata in rete
trigger:
  - platform: time_pattern
    seconds: /10
condition: []
action:
  - variables:
      grid_power: >
        {% set gp = states('sensor.generale_total_active_power') %} {% if gp not
        in ['unknown', 'unavailable', 'none', 'None', '', None] %}
          {{ gp | float }}
        {% else %}
          {{ states('sensor.shellyem3_483fdac3d228_channel_a_power') | float }}
        {% endif %}
      max_charging_power: 2400
      min_charging_power: 200
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ grid_power > -200 }}"
        sequence:
          - target:
              entity_id: switch.carico_batteria_ecoflow
            action: switch.turn_off
            data: {}
      - conditions:
          - condition: template
            value_template: "{{ grid_power <= -200 }}"
        sequence:
          - target:
              entity_id: switch.carico_batteria_ecoflow
            action: switch.turn_on
            data: {}
          - target:
              entity_id: number.delta_2_max_0411_ac_charging_power
            data:
              value: >
                {% set exported_power = -grid_power %}  {# Calcola la potenza
                esportata (valore positivo) #} {% if exported_power >
                max_charging_power %}  {# Se l'esportazione supera la potenza
                massima consentita #}
                  {{ max_charging_power }}  {# Imposta la potenza di carica al massimo consentito #}
                {% elif exported_power < min_charging_power %}  {# Se
                l'esportazione Ã¨ inferiore alla potenza minima consentita #}
                  {{ min_charging_power }}  {# Imposta la potenza di carica al minimo consentito #}
                {% else %}
                  {{ exported_power | int }}  {# Imposta la potenza di carica pari alla potenza esportata #}
                {% endif %}
            action: number.set_value
mode: single
